<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Inpainting Demo</title>
    <style>
        canvas {
            border: 1px solid black;
            cursor: crosshair;
        }
        #result img {
            margin: 10px;
            width: 200px;
            height: auto;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            color: blue;
            font-weight: bold;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: left;
            padding: 10px;
            border-radius: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <h2>Image Inpainting Demo</h2>

    <!-- Image Upload -->
    <input type="file" id="uploadImage" accept="image/*">
    <canvas id="canvas" width="512" height="512"></canvas>
    <br>

    <!-- Mask Drawing Mode -->
    <label>
        <input type="radio" name="mode" value="brush" checked>
        Brush
    </label>
    <label>
        <input type="radio" name="mode" value="rectangle">
        Rectangle
    </label>
    <div id="brushOptions">
        <label for="brushSize">Brush Size:</label>
        <input type="range" id="brushSize" min="1" max="50" value="10">
        <span id="brushSizeValue">10</span>
    </div>

    <!-- Parameters -->
    <div>
        <label for="numImages">Number of Images:</label>
        <input type="range" id="numImages" min="1" max="10" value="3">
        <span id="numImagesValue">3</span>
    </div>
    <div>
        <label for="numInferenceSteps">Inference Steps:</label>
        <input type="range" id="numInferenceSteps" min="5" max="50" value="20">
        <span id="numInferenceStepsValue">20</span>
    </div>
    <div>
        <label for="guidanceScale">Guidance Scale:</label>
        <input type="range" id="guidanceScale" min="1.0" max="20.0" step="0.5" value="7.5">
        <span id="guidanceScaleValue">7.5</span>
    </div>

    <!-- Description -->
    <textarea id="description" placeholder="Enter description here"></textarea>
    <button id="generateButton">Generate</button>
    <button id="clearButton">Clear</button> <!-- 新增清空按钮 -->

    <!-- Results -->
    <div id="result">
        <h3>Results:</h3>
        <div id="resultImages"></div>
    </div>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const uploadImage = document.getElementById("uploadImage");
        const brushSizeInput = document.getElementById("brushSize");
        const numImagesInput = document.getElementById("numImages");
        const numInferenceStepsInput = document.getElementById("numInferenceSteps");
        const guidanceScaleInput = document.getElementById("guidanceScale");
        const brushSizeValue = document.getElementById("brushSizeValue");
        const numImagesValue = document.getElementById("numImagesValue");
        const numInferenceStepsValue = document.getElementById("numInferenceStepsValue");
        const guidanceScaleValue = document.getElementById("guidanceScaleValue");
        const clearButton = document.getElementById("clearButton");
        let drawing = false;
        let image = null;
        let startX, startY;

        // Update displayed values for sliders
        const updateSliderValue = (input, display) => {
            input.addEventListener("input", () => {
                display.textContent = input.value;
            });
        };
        updateSliderValue(brushSizeInput, brushSizeValue);
        updateSliderValue(numImagesInput, numImagesValue);
        updateSliderValue(numInferenceStepsInput, numInferenceStepsValue);
        updateSliderValue(guidanceScaleInput, guidanceScaleValue);

        // Load image onto canvas
        uploadImage.onchange = (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                image = new Image();
                image.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                };
                image.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // Drawing functions
        const drawBrush = (x, y) => {
			const brushSize = parseInt(brushSizeInput.value, 10);
			ctx.globalAlpha = 0.5; // 设置透明度，仅用于前端显示
			ctx.fillStyle = "rgb(255, 255, 255)"; // 白色
			ctx.beginPath();
			ctx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
			ctx.fill();
			ctx.globalAlpha = 1.0; // 恢复默认透明度
		};

		// Rectangle drawing with transparency for visualization
		const drawRectangle = (x, y, width, height) => {
			ctx.globalAlpha = 0.5; // 设置透明度，仅用于前端显示
			ctx.fillStyle = "rgb(255, 255, 255)"; // 白色
			ctx.fillRect(x, y, width, height);
			ctx.globalAlpha = 1.0; // 恢复默认透明度
		};
		
		
		// Prepare mask data (binarize) before sending to backend
		const prepareBinaryMask = async () => {
			const maskCanvas = document.createElement("canvas");
			const maskCtx = maskCanvas.getContext("2d");
			maskCanvas.width = canvas.width;
			maskCanvas.height = canvas.height;

			// Copy current canvas to mask canvas
			maskCtx.drawImage(canvas, 0, 0);

			// Get image data and binarize
			const imageData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
			const data = imageData.data;
			for (let i = 0; i < data.length; i += 4) {
				// 如果遮罩像素的亮度 > 128，则设置为白色（255），否则为黑色（0）
				const brightness = data[i]; // 只需检查R通道即可，假设R=G=B
				const binarizedValue = brightness > 128 ? 255 : 0;
				data[i] = binarizedValue; // R
				data[i + 1] = binarizedValue; // G
				data[i + 2] = binarizedValue; // B
				data[i + 3] = 255; // Alpha
			}
			maskCtx.putImageData(imageData, 0, 0);

			// Return the binarized mask as a Blob
			return new Promise((resolve) => maskCanvas.toBlob(resolve, "image/png"));
		};

		// Sending data to backend
		document.getElementById("generateButton").onclick = async () => {
			const description = document.getElementById("description").value;
			const numImages = numImagesInput.value;
			const numInferenceSteps = numInferenceStepsInput.value;
			const guidanceScale = guidanceScaleInput.value;

			if (!image || !description) {
				alert("Please upload an image and enter a description.");
				return;
			}

			const imageBlob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
			const maskBlob = await prepareBinaryMask(); // 获取二值化遮罩

			const formData = new FormData();
			formData.append("image", imageBlob);
			formData.append("mask", maskBlob);
			formData.append("description", description);
			formData.append("num_images", numImages);
			formData.append("num_inference_steps", numInferenceSteps);
			formData.append("guidance_scale", guidanceScale);

			const response = await fetch("https://your-ngrok-url.ngrok-free.app/generate", {
				method: "POST",
				body: formData,
			});
			const data = await response.json();

			const resultDiv = document.getElementById("resultImages");
			resultDiv.innerHTML = "";
			data.images.forEach((imgBase64) => {
				const imgElement = document.createElement("img");
				imgElement.src = "data:image/png;base64," + imgBase64;
				resultDiv.appendChild(imgElement);
			});
		};
        // Handle canvas interactions
        canvas.addEventListener("mousedown", (e) => {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (mode === "brush") {
                drawing = true;
                drawBrush(x, y);
            } else {
                startX = x;
                startY = y;
                drawing = true;
            }
        });

        canvas.addEventListener("mousemove", (e) => {
            if (drawing && document.querySelector('input[name="mode"]:checked').value === "brush") {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                drawBrush(x, y);
            }
        });

        canvas.addEventListener("mouseup", (e) => {
            if (document.querySelector('input[name="mode"]:checked').value === "rectangle" && drawing) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const width = x - startX;
                const height = y - startY;
                drawRectangle(startX, startY, width, height);
            }
            drawing = false;
        });

        // Clear canvas
        clearButton.onclick = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image) {
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height); // 保留原始图像
            }
        };

        // Send data to backend
        document.getElementById("generateButton").onclick = async () => {
            const description = document.getElementById("description").value;
            const numImages = numImagesInput.value;
            const numInferenceSteps = numInferenceStepsInput.value;
            const guidanceScale = guidanceScaleInput.value;

            if (!image || !description) {
                alert("Please upload an image and enter a description.");
                return;
            }

            const imageBlob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
            const maskBlob = await new Promise((resolve) => {
                const maskCanvas = document.createElement("canvas");
                const maskCtx = maskCanvas.getContext("2d");
                maskCanvas.width = canvas.width;
                maskCanvas.height = canvas.height;
                maskCtx.fillStyle = "black";
                maskCtx.fillRect(0, 0, canvas.width, canvas.height);
                maskCtx.drawImage(canvas, 0, 0);
                maskCanvas.toBlob(resolve, "image/png");
            });

            const formData = new FormData();
            formData.append("image", imageBlob);
            formData.append("mask", maskBlob);
            formData.append("description", description);
            formData.append("num_images", numImages);
            formData.append("num_inference_steps", numInferenceSteps);
            formData.append("guidance_scale", guidanceScale);

            const response = await fetch("https://7ecc-34-83-242-255.ngrok-free.app/generate", {
                method: "POST",
                body: formData,
            });
            const data = await response.json();

            const resultDiv = document.getElementById("resultImages");
            resultDiv.innerHTML = "";
            data.images.forEach((imgBase64) => {
                const imgElement = document.createElement("img");
                imgElement.src = "data:image/png;base64," + imgBase64;
                resultDiv.appendChild(imgElement);
            });
        };
    </script>
</body>
</html>
