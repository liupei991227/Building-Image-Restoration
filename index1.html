<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Inpainting Demo</title>
    <!-- 引入 Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        canvas {
            border: 1px solid black;
            cursor: crosshair;
            max-width: 100%;
        }
        #resultImages img {
            margin: 10px;
            width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-container .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: left;
            padding: 10px;
            border-radius: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip-container:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
<div class="container my-4">
    <h2 class="text-center">Image Inpainting Demo</h2>

    <!-- Language Selector -->
    <div class="mb-3 text-end">
        <label for="languageSelector" class="form-label">Language:</label>
        <select id="languageSelector" class="form-select w-auto d-inline">
            <option value="en" selected>English</option>
            <option value="zh">中文</option>
        </select>
    </div>

    <!-- Image Upload -->
    <div class="mb-3">
        <label class="form-label">Upload Image:</label>
        <input type="file" id="uploadImage" accept="image/*" class="form-control">
    </div>

    <!-- Canvas -->
    <div class="mb-3">
        <canvas id="canvas" width="512" height="512"></canvas>
    </div>

    <!-- Drawing Mode -->
    <div class="mb-3">
        <label class="form-label">Drawing Mode:</label>
        <div>
            <input type="radio" id="brushMode" name="mode" value="brush" checked>
            <label for="brushMode">Brush</label>
            <input type="radio" id="rectangleMode" name="mode" value="rectangle">
            <label for="rectangleMode">Rectangle</label>
        </div>
    </div>

    <!-- Brush Size -->
    <div class="mb-3">
        <label class="form-label">Brush Size:</label>
        <div class="tooltip-container">
            <input type="range" id="brushSize" min="1" max="50" value="10" class="form-range">
            <span id="brushSizeValue">10</span>
            <span class="tooltiptext">Adjust the brush size for drawing.</span>
        </div>
    </div>

    <!-- Parameters -->
    <div class="mb-3">
        <label class="form-label">Number of Images:</label>
        <div class="tooltip-container">
            <input type="range" id="numImages" min="1" max="10" value="3" class="form-range">
            <span id="numImagesValue">3</span>
            <span class="tooltiptext">Set how many images to generate at once.</span>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Inference Steps:</label>
        <div class="tooltip-container">
            <input type="range" id="numInferenceSteps" min="5" max="50" value="20" class="form-range">
            <span id="numInferenceStepsValue">20</span>
            <span class="tooltiptext">Control the quality and speed of generation.</span>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Guidance Scale:</label>
        <div class="tooltip-container">
            <input type="range" id="guidanceScale" min="1.0" max="20.0" step="0.5" value="7.5" class="form-range">
            <span id="guidanceScaleValue">7.5</span>
            <span class="tooltiptext">Adjust how closely the result follows the description.</span>
        </div>
    </div>

    <!-- Description -->
    <div class="mb-3">
        <textarea id="description" placeholder="Enter description here" class="form-control"></textarea>
    </div>

    <!-- Buttons -->
    <div class="d-flex justify-content-between">
        <button id="generateButton" class="btn btn-primary">Generate</button>
        <button id="clearButton" class="btn btn-secondary">Clear</button>
    </div>
    <div id="loading" class="text-center text-primary my-3" style="display: none;">Generating... Please wait.</div>

    <!-- Results -->
    <div id="result" class="mt-4">
        <h3>Results:</h3>
        <div id="resultImages" class="row g-3"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const uploadImage = document.getElementById("uploadImage");
    const brushSizeInput = document.getElementById("brushSize");
    const numImagesInput = document.getElementById("numImages");
    const numInferenceStepsInput = document.getElementById("numInferenceSteps");
    const guidanceScaleInput = document.getElementById("guidanceScale");
    const brushSizeValue = document.getElementById("brushSizeValue");
    const numImagesValue = document.getElementById("numImagesValue");
    const numInferenceStepsValue = document.getElementById("numInferenceStepsValue");
    const guidanceScaleValue = document.getElementById("guidanceScaleValue");
    const clearButton = document.getElementById("clearButton");
    const loadingText = document.getElementById("loading");
    const resultImagesDiv = document.getElementById("resultImages");
    let drawing = false;
    let image = null;
    let startX, startY;

    // Update slider value display
    const updateSliderValue = (slider, valueDisplay) => {
        slider.addEventListener("input", () => {
            valueDisplay.textContent = slider.value;
        });
    };

    updateSliderValue(brushSizeInput, brushSizeValue);
    updateSliderValue(numImagesInput, numImagesValue);
    updateSliderValue(numInferenceStepsInput, numInferenceStepsValue);
    updateSliderValue(guidanceScaleInput, guidanceScaleValue);

    // Upload image to canvas
    uploadImage.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            image = new Image();
            image.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            };
            image.src = reader.result;
        };
        reader.readAsDataURL(file);
    });

    // Drawing functions
    const drawBrush = (x, y) => {
        const size = parseInt(brushSizeInput.value, 10);
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(x, y, size / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1.0;
    };

    const drawRectangle = (x, y, width, height) => {
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = "white";
        ctx.fillRect(x, y, width, height);
        ctx.globalAlpha = 1.0;
    };

    // Event listeners for drawing
    canvas.addEventListener("mousedown", (e) => {
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        drawing = true;
    });

    canvas.addEventListener("mousemove", (e) => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        if (document.querySelector('input[name="mode"]:checked').value === "brush") {
            drawBrush(x, y);
        }
    });

    canvas.addEventListener("mouseup", (e) => {
        if (drawing && document.querySelector('input[name="mode"]:checked').value === "rectangle") {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            drawRectangle(startX, startY, x - startX, y - startY);
        }
        drawing = false;
    });

    // Clear button
    clearButton.addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (image) ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    });

    // Prepare mask for backend
    const prepareMask = () => {
        const maskCanvas = document.createElement("canvas");
        const maskCtx = maskCanvas.getContext("2d");
        maskCanvas.width = canvas.width;
        maskCanvas.height = canvas.height;
        maskCtx.drawImage(canvas, 0, 0);
        const imageData = maskCtx.getImageData(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < imageData.data.length; i += 4) {
            const brightness = imageData.data[i];
            const value = brightness > 128 ? 255 : 0;
            imageData.data[i] = value;
            imageData.data[i + 1] = value;
            imageData.data[i + 2] = value;
            imageData.data[i + 3] = 255;
        }
        maskCtx.putImageData(imageData, 0, 0);
        return new Promise((resolve) => maskCanvas.toBlob(resolve, "image/png"));
    };

    // Generate button
    document.getElementById("generateButton").addEventListener("click", async () => {
        if (!image) {
            alert("Please upload an image.");
            return;
        }
        const description = document.getElementById("description").value.trim();
        if (!description) {
            alert("Please enter a description.");
            return;
        }

        loadingText.style.display = "block";
        const maskBlob = await prepareMask();
        const imageBlob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
        const formData = new FormData();
        formData.append("image", imageBlob);
        formData.append("mask", maskBlob);
        formData.append("description", description);
        formData.append("num_images", numImagesInput.value);
        formData.append("num_inference_steps", numInferenceStepsInput.value);
        formData.append("guidance_scale", guidanceScaleInput.value);

        try {
            const response = await fetch("https://deff-34-125-186-149.ngrok-free.app/generate", { method: "POST", body: formData });
            const data = await response.json();
            resultImagesDiv.innerHTML = "";
            data.images.forEach((imgBase64) => {
                const img = document.createElement("img");
                img.src = `data:image/png;base64,${imgBase64}`;
                resultImagesDiv.appendChild(img);
            });
        } catch (error) {
            alert("Error occurred while generating images.");
        } finally {
            loadingText.style.display = "none";
        }
    });
</script>
</body>
</html>
