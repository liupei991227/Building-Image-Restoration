<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Inpainting Demo</title>
    <style>
        canvas {
            border: 1px solid black;
            cursor: crosshair;
        }
        #resultImages {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #resultImages img {
            flex: 1 1 calc(33.333% - 10px); /* 三列布局 */
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            color: blue;
            font-weight: bold;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: left;
            padding: 10px;
            border-radius: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        input[name="mode"]:checked + label {
            background-color: #007BFF;
            color: white;
            border-radius: 5px;
            padding: 5px;
        }
        #loading {
            display: none;
            font-size: 16px;
            color: #007BFF;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h2>Image Inpainting Demo</h2>

    <!-- Image Upload -->
    <input type="file" id="uploadImage" accept="image/*">
    <canvas id="canvas" width="512" height="512"></canvas>
    <br>

    <!-- Mask Drawing Mode -->
    <div>
        <input type="radio" id="brushMode" name="mode" value="brush" checked>
        <label for="brushMode">Brush</label>
        <input type="radio" id="rectangleMode" name="mode" value="rectangle">
        <label for="rectangleMode">Rectangle</label>
    </div>
    <div id="brushOptions">
        <label for="brushSize">Brush Size:</label>
        <input type="range" id="brushSize" min="1" max="50" value="10">
        <span id="brushSizeValue">10</span>
    </div>

    <!-- Parameters -->
    <div>
        <label for="numImages">Number of Images:</label>
        <input type="range" id="numImages" min="1" max="10" value="3">
        <span id="numImagesValue">3</span>
    </div>
    <div>
        <label for="numInferenceSteps">Inference Steps:</label>
        <input type="range" id="numInferenceSteps" min="5" max="50" value="20">
        <span id="numInferenceStepsValue">20</span>
    </div>
    <div>
        <label for="guidanceScale">Guidance Scale:</label>
        <input type="range" id="guidanceScale" min="1.0" max="20.0" step="0.5" value="7.5">
        <span id="guidanceScaleValue">7.5</span>
    </div>

    <!-- Description -->
    <textarea id="description" placeholder="Enter description here"></textarea>
    <button id="generateButton">Generate</button>
    <button id="clearButton">Clear</button>
    <div id="loading">Generating... Please wait.</div>

    <!-- Results -->
    <div id="result">
        <h3>Results:</h3>
        <div id="resultImages"></div>
    </div>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const uploadImage = document.getElementById("uploadImage");
        const brushSizeInput = document.getElementById("brushSize");
        const numImagesInput = document.getElementById("numImages");
        const numInferenceStepsInput = document.getElementById("numInferenceSteps");
        const guidanceScaleInput = document.getElementById("guidanceScale");
        const brushSizeValue = document.getElementById("brushSizeValue");
        const numImagesValue = document.getElementById("numImagesValue");
        const numInferenceStepsValue = document.getElementById("numInferenceStepsValue");
        const guidanceScaleValue = document.getElementById("guidanceScaleValue");
        const clearButton = document.getElementById("clearButton");
        const loadingText = document.getElementById("loading");
        let drawing = false;
        let image = null;
        let startX, startY;

        // Update slider values
        const updateSliderValue = (input, display) => {
            input.addEventListener("input", () => {
                display.textContent = input.value;
            });
        };
        updateSliderValue(brushSizeInput, brushSizeValue);
        updateSliderValue(numImagesInput, numImagesValue);
        updateSliderValue(numInferenceStepsInput, numInferenceStepsValue);
        updateSliderValue(guidanceScaleInput, guidanceScaleValue);

        // Load image onto canvas
        uploadImage.onchange = (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                image = new Image();
                image.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                };
                image.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // Drawing functions
        const drawBrush = (x, y) => {
            const brushSize = parseInt(brushSizeInput.value, 10);
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = "rgb(255, 255, 255)";
            ctx.beginPath();
            ctx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        };

        const drawRectangle = (x, y, width, height) => {
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = "rgb(255, 255, 255)";
            ctx.fillRect(x, y, width, height);
            ctx.globalAlpha = 1.0;
        };

        // Canvas interactions
        canvas.addEventListener("mousedown", (e) => {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (mode === "brush") {
                drawing = true;
                drawBrush(x, y);
            } else {
                startX = x;
                startY = y;
                drawing = true;
            }
        });

        canvas.addEventListener("mousemove", (e) => {
            if (drawing && document.querySelector('input[name="mode"]:checked').value === "brush") {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                drawBrush(x, y);
            }
        });

        canvas.addEventListener("mouseup", (e) => {
            if (document.querySelector('input[name="mode"]:checked').value === "rectangle" && drawing) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const width = x - startX;
                const height = y - startY;
                drawRectangle(startX, startY, width, height);
            }
            drawing = false;
        });

        // Clear canvas
        clearButton.onclick = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image) {
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            }
        };

        // Send data to backend
        document.getElementById("generateButton").onclick = async () => {
            const description = document.getElementById("description").value;
            const numImages = numImagesInput.value;
            const numInferenceSteps = numInferenceStepsInput.value;
            const guidanceScale = guidanceScaleInput.value;

            if (!image) {
                alert("Please upload an image.");
                return;
            }
            if (!description.trim()) {
                alert("Please enter a description.");
                return;
            }

            loadingText.style.display = "block"; // Show loading text
            const imageBlob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
            const maskBlob = await prepareBinaryMask();

            const formData = new FormData();
            formData.append("image", imageBlob);
            formData.append("mask", maskBlob);
            formData.append("description", description);
            formData.append("num_images", numImages);
            formData.append("num_inference_steps", numInferenceSteps);
            formData.append("guidance_scale", guidanceScale);

            try {
                const response = await fetch("https://7ecc-34-83-242-255.ngrok-free.app/generate", {
                    method: "POST",
                    body: formData,
                });
                const data = await response.json();

                const resultDiv = document.getElementById("resultImages");
                resultDiv.innerHTML = "";
                data.images.forEach((imgBase64) => {
                    const imgElement = document.createElement("img");
                    imgElement.src = "data:image/png;base64," + imgBase64;
                    resultDiv.appendChild(imgElement);
                });
            } catch (error) {
                alert("An error occurred while generating the images.");
            } finally {
                loadingText.style.display = "none"; // Hide loading text
            }
        };

        const prepareBinaryMask = async () => {
            const maskCanvas = document.createElement("canvas");
            const maskCtx = maskCanvas.getContext("2d");
            maskCanvas.width = canvas.width;
            maskCanvas.height = canvas.height;

            maskCtx.drawImage(canvas, 0, 0);

            const imageData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const brightness = data[i];
                const binarizedValue = brightness > 128 ? 255 : 0;
                data[i] = binarizedValue;
                data[i + 1] = binarizedValue;
                data[i + 2] = binarizedValue;
                data[i + 3] = 255;
            }
            maskCtx.putImageData(imageData, 0, 0);

            return new Promise((resolve) => maskCanvas.toBlob(resolve, "image/png"));
        };
    </script>
</body>
</html>
